name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI and jq
        run: |
          npm install -g eas-cli
          sudo apt-get update && sudo apt-get install -y jq || echo "jq install failed, will use alternative method"

      - name: Build Android APK
        id: build
        run: |
          echo "ðŸš€ Starting Android APK build..."
          echo "Using profile: production"
          echo "Platform: android"
          
          # Run build command and capture output
          set +e
          BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive 2>&1)
          BUILD_EXIT_CODE=$?
          
          echo "--- Build Command Output ---"
          echo "$BUILD_OUTPUT"
          echo "--- End Output ---"
          echo ""
          echo "Exit code: $BUILD_EXIT_CODE"
          
          # Wait for build to register in EAS
          echo ""
          echo "â³ Waiting 15 seconds for build to register in EAS..."
          sleep 15
          
          # Check for build in EAS
          echo "ðŸ“¥ Checking for build in EAS..."
          BUILD_LIST=$(eas build:list --platform android --limit 5 --json 2>&1)
          
          echo "--- Build List Output ---"
          echo "$BUILD_LIST" | head -20
          echo "--- End Output ---"
          
          # Parse build ID from the list
          if echo "$BUILD_LIST" | jq -e '.[0].id' > /dev/null 2>&1; then
            NEWEST_BUILD_ID=$(echo "$BUILD_LIST" | jq -r '.[0].id')
            NEWEST_BUILD_STATUS=$(echo "$BUILD_LIST" | jq -r '.[0].status // "unknown"')
            NEWEST_BUILD_URL=$(echo "$BUILD_LIST" | jq -r '.[0].url // ""')
            
            echo ""
            echo "âœ… âœ… BUILD FOUND IN EAS!"
            echo "Build ID: $NEWEST_BUILD_ID"
            echo "Status: $NEWEST_BUILD_STATUS"
            echo "URL: $NEWEST_BUILD_URL"
            
            echo "build_queued=true" >> $GITHUB_OUTPUT
            echo "build_id=$NEWEST_BUILD_ID" >> $GITHUB_OUTPUT
            echo "build_status=$NEWEST_BUILD_STATUS" >> $GITHUB_OUTPUT
            echo "build_url=$NEWEST_BUILD_URL" >> $GITHUB_OUTPUT
            
            # Success - build was queued
            exit 0
          else
            echo ""
            echo "âš ï¸ Could not find build in EAS list"
            
            # Check if there was an authentication error
            if echo "$BUILD_OUTPUT" | grep -i "unauthorized\|authentication\|token" > /dev/null; then
              echo "âŒ Authentication error detected!"
              echo "Please check EXPO_TOKEN secret"
              exit 1
            fi
            
            # Check if there was a different error
            if [ $BUILD_EXIT_CODE -ne 0 ] && [ $BUILD_EXIT_CODE -ne 1 ]; then
              echo "âŒ Build command failed with exit code $BUILD_EXIT_CODE"
              exit $BUILD_EXIT_CODE
            fi
            
            # Exit code 1 is often normal for async builds
            echo "â„¹ï¸ Build command exited with code $BUILD_EXIT_CODE"
            echo "This might be normal. Check EAS dashboard manually."
            echo "build_queued=unknown" >> $GITHUB_OUTPUT
            exit 0  # Treat as success for now
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PUBLIC_API_URL: ${{ secrets.EXPO_PUBLIC_API_URL || 'https://periods-testing-backend.vercel.app' }}

      - name: Display Build Information
        if: steps.build.outputs.build_queued == 'true'
        run: |
          echo "## âœ… Build Successfully Queued!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID:** ${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.build.outputs.build_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated Time:** ~10-15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.build.outputs.build_url }}" ]; then
            echo "**View Build:** [${{ steps.build.outputs.build_url }}](${{ steps.build.outputs.build_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**ðŸ“¥ Download Instructions:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [EAS Dashboard](https://expo.dev/accounts/akanksha_singh/projects/period-tracker/builds)" >> $GITHUB_STEP_SUMMARY
          echo "2. Find build ID: \`${{ steps.build.outputs.build_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Wait for status to show 'Finished' (~10-15 min)" >> $GITHUB_STEP_SUMMARY
          echo "4. Click download button to get your APK" >> $GITHUB_STEP_SUMMARY

      - name: Build Status Fallback
        if: steps.build.outputs.build_queued != 'true'
        run: |
          echo "## âš ï¸ Build Status Unknown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build command completed, but we couldn't verify if it was queued." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Please check manually:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [EAS Dashboard](https://expo.dev/accounts/akanksha_singh/projects/period-tracker/builds)" >> $GITHUB_STEP_SUMMARY
          echo "2. Look for a new build in the list" >> $GITHUB_STEP_SUMMARY
          echo "3. If you see a new build, it's working! Just wait ~10-15 min for it to complete." >> $GITHUB_STEP_SUMMARY
